<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BabyAGI Architecture Diagrams</title>
    <script src="https://unpkg.com/beautiful-mermaid/dist/beautiful-mermaid.browser.global.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --accent-hover: #79b8ff;
            --border: #30363d;
            --success: #3fb950;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        header h1::before {
            content: 'ðŸ§’';
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .nav-tab:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .diagram-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .diagram-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .diagram-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .diagram-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .diagram-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .diagram-header .badge {
            background: var(--bg-tertiary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .diagram-content {
            padding: 2rem;
            overflow-x: auto;
            display: flex;
            justify-content: center;
            min-height: 400px;
            align-items: center;
        }

        .diagram-content svg {
            max-width: 100%;
            height: auto;
        }

        .description {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            color: #f85149;
            padding: 1rem;
            background: rgba(248, 81, 73, 0.1);
            border-radius: 6px;
        }

        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }

        footer a {
            color: var(--accent);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                text-align: center;
            }

            .diagram-content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>BabyAGI Architecture</h1>
        <p class="subtitle">Interactive Mermaid diagrams powered by beautiful-mermaid</p>
    </header>

    <div class="container">
        <nav class="nav-tabs">
            <button class="nav-tab active" data-target="overview">System Overview</button>
            <button class="nav-tab" data-target="message-flow">Message Flow</button>
            <button class="nav-tab" data-target="memory">Memory System</button>
            <button class="nav-tab" data-target="tools">Tool System</button>
            <button class="nav-tab" data-target="scheduler">Scheduler</button>
            <button class="nav-tab" data-target="events">Event System</button>
            <button class="nav-tab" data-target="channels">Multi-Channel</button>
            <button class="nav-tab" data-target="models">Data Models</button>
            <button class="nav-tab" data-target="files">File Structure</button>
            <button class="nav-tab" data-target="complete">Complete Flow</button>
        </nav>

        <!-- System Overview -->
        <section id="overview" class="diagram-section active">
            <div class="diagram-card">
                <div class="diagram-header">
                    <h2>High-Level System Architecture</h2>
                    <span class="badge">Flowchart</span>
                </div>
                <div class="diagram-content" data-diagram="overview"></div>
                <div class="description">
                    Complete overview showing all major components: entry points, configuration, agent core,
                    input/output channels, tools, memory system, and external service integrations.
                </div>
            </div>
        </section>

        <!-- Message Flow -->
        <section id="message-flow" class="diagram-section">
            <div class="diagram-card">
                <div class="diagram-header">
                    <h2>Message Processing Flow</h2>
                    <span class="badge">Sequence Diagram</span>
                </div>
                <div class="diagram-content" data-diagram="message-flow"></div>
                <div class="description">
                    Shows the complete flow from user input through Claude API calls, tool execution,
                    memory logging, and response delivery back to the user.
                </div>
            </div>
        </section>

        <!-- Memory System -->
        <section id="memory" class="diagram-section">
            <div class="diagram-card">
                <div class="diagram-header">
                    <h2>Memory System Architecture</h2>
                    <span class="badge">Flowchart</span>
                </div>
                <div class="diagram-content" data-diagram="memory"></div>
                <div class="description">
                    SQLite-backed knowledge graph with event logging, entity/relationship extraction,
                    hierarchical summaries, semantic search, and context assembly.
                </div>
            </div>
        </section>

        <!-- Tool System -->
        <section id="tools" class="diagram-section">
            <div class="diagram-card">
                <div class="diagram-header">
                    <h2>Tool System Architecture</h2>
                    <span class="badge">Flowchart</span>
                </div>
                <div class="diagram-content" data-diagram="tools"></div>
                <div class="description">
                    Decorator-based tool registration with automatic JSON schema generation,
                    built-in and external tools, and thread pool execution.
                </div>
            </div>
        </section>

        <!-- Scheduler -->
        <section id="scheduler" class="diagram-section">
            <div class="diagram-card">
                <div class="diagram-header">
                    <h2>Scheduler & Background Objectives</h2>
                    <span class="badge">Flowchart</span>
                </div>
                <div class="diagram-content" data-diagram="scheduler"></div>
                <div class="description">
                    Task scheduling with cron, interval, and one-time execution. Background objectives
                    run in dedicated threads independently of the main conversation.
                </div>
            </div>
        </section>

        <!-- Event System -->
        <section id="events" class="diagram-section">
            <div class="diagram-card">
                <div class="diagram-header">
                    <h2>Event System</h2>
                    <span class="badge">Flowchart</span>
                </div>
                <div class="diagram-content" data-diagram="events"></div>
                <div class="description">
                    EventEmitter-based pub/sub system enabling loose coupling between components.
                    Events include tool execution, objectives, scheduled tasks, and agent responses.
                </div>
            </div>
        </section>

        <!-- Multi-Channel -->
        <section id="channels" class="diagram-section">
            <div class="diagram-card">
                <div class="diagram-header">
                    <h2>Multi-Channel Architecture</h2>
                    <span class="badge">Flowchart</span>
                </div>
                <div class="diagram-content" data-diagram="channels"></div>
                <div class="description">
                    Concurrent input listeners (CLI, Email, Voice, API) and output senders with
                    per-thread locks ensuring thread-safe message processing.
                </div>
            </div>
        </section>

        <!-- Data Models -->
        <section id="models" class="diagram-section">
            <div class="diagram-card">
                <div class="diagram-header">
                    <h2>Data Models</h2>
                    <span class="badge">Class Diagram</span>
                </div>
                <div class="diagram-content" data-diagram="models"></div>
                <div class="description">
                    Core data classes: Agent, Objective, Tool, ScheduledTask, Schedule,
                    and Memory system models (Event, Entity, Edge, SummaryNode).
                </div>
            </div>
        </section>

        <!-- File Structure -->
        <section id="files" class="diagram-section">
            <div class="diagram-card">
                <div class="diagram-header">
                    <h2>File Structure Overview</h2>
                    <span class="badge">Flowchart</span>
                </div>
                <div class="diagram-content" data-diagram="files"></div>
                <div class="description">
                    Visual representation of the project directory structure showing the relationships
                    between modules in the babyagi codebase.
                </div>
            </div>
        </section>

        <!-- Complete Flow -->
        <section id="complete" class="diagram-section">
            <div class="diagram-card">
                <div class="diagram-header">
                    <h2>Complete System Flow</h2>
                    <span class="badge">Flowchart</span>
                </div>
                <div class="diagram-content" data-diagram="complete"></div>
                <div class="description">
                    End-to-end flowchart from application startup through mode selection,
                    initialization, listener setup, and message processing loop.
                </div>
            </div>
        </section>
    </div>

    <footer>
        <p>Rendered with <a href="https://github.com/lukilabs/beautiful-mermaid" target="_blank">beautiful-mermaid</a></p>
        <p>BabyAGI v0.3.0 &bull; <a href="https://github.com/yoheinakajima/babyagi" target="_blank">GitHub</a></p>
    </footer>

    <script>
        const diagrams = {
            'overview': `flowchart TB
    subgraph Entry["Entry Points"]
        CLI_MODE["CLI Mode"]
        CHANNELS_MODE["Channels Mode"]
        SERVER_MODE["Server Mode"]
    end

    subgraph Config["Configuration"]
        CONFIG_YAML["config.yaml"]
        ENV_VARS["Environment Variables"]
    end

    subgraph Core["Agent Core"]
        AGENT["Agent Class"]
        THREADS["Message Threads"]
        OBJECTIVES["Background Objectives"]
        SCHEDULER["Scheduler"]
    end

    subgraph Listeners["Input Channels"]
        CLI_L["CLI"]
        EMAIL_L["Email"]
        VOICE_L["Voice"]
    end

    subgraph Senders["Output Channels"]
        CLI_S["Terminal"]
        EMAIL_S["Email"]
    end

    subgraph Tools["Tools System"]
        WEB["Web Search"]
        SANDBOX["Code Sandbox"]
        SECRETS["Credentials"]
    end

    subgraph Memory["Memory System"]
        STORE["SQLite Store"]
        EXTRACTION["Extraction"]
        SUMMARIES["Summaries"]
    end

    subgraph External["External Services"]
        CLAUDE["Claude API"]
        E2B["E2B Sandbox"]
        AGENTMAIL["AgentMail"]
    end

    Entry --> Config
    Config --> AGENT
    AGENT --> THREADS
    AGENT --> OBJECTIVES
    AGENT --> SCHEDULER
    Listeners --> AGENT
    AGENT --> Senders
    Tools --> AGENT
    AGENT --> Memory
    AGENT --> CLAUDE
    SANDBOX --> E2B
    EMAIL_L --> AGENTMAIL
    EMAIL_S --> AGENTMAIL`,

            'message-flow': `sequenceDiagram
    participant User
    participant Listener
    participant Agent
    participant Claude
    participant Tools
    participant Memory
    participant Sender

    User->>Listener: Input message
    Listener->>Agent: run_async()
    Agent->>Agent: Acquire lock
    Agent->>Memory: Get context
    Memory-->>Agent: Memories

    loop Until end_turn
        Agent->>Claude: API call
        Claude-->>Agent: Response
        alt Tool Use
            Agent->>Tools: Execute
            Tools-->>Agent: Result
        end
    end

    Agent->>Memory: Log event
    Agent->>Sender: Send response
    Sender->>User: Display`,

            'memory': `flowchart TB
    subgraph Events["Event Logging"]
        LOG["log_event()"]
        EVENT["Event Model"]
    end

    subgraph Storage["SQLite Tables"]
        EVENTS_T["events"]
        ENTITIES_T["entities"]
        EDGES_T["edges"]
        TOPICS_T["topics"]
        SUMMARIES_T["summaries"]
    end

    subgraph Extraction["Extraction Pipeline"]
        EXT_ENT["Extract Entities"]
        EXT_EDGE["Extract Relationships"]
        EXT_TOPIC["Extract Topics"]
    end

    subgraph Retrieval["Retrieval System"]
        QUICK["Quick Retrieval"]
        SEMANTIC["Semantic Search"]
        CONTEXT["Context Assembly"]
    end

    LOG --> EVENT
    EVENT --> EVENTS_T
    EVENTS_T --> EXT_ENT
    EXT_ENT --> ENTITIES_T
    EXT_ENT --> EXT_EDGE
    EXT_EDGE --> EDGES_T
    EXT_ENT --> EXT_TOPIC
    EXT_TOPIC --> TOPICS_T
    EVENTS_T --> SUMMARIES_T
    ENTITIES_T --> QUICK
    SUMMARIES_T --> CONTEXT
    EVENTS_T --> SEMANTIC
    SEMANTIC --> CONTEXT`,

            'tools': `flowchart LR
    subgraph Registration["Tool Registration"]
        DEC["@tool decorator"]
        SCHEMA["JSON Schema"]
    end

    subgraph BuiltIn["Built-in Tools"]
        MEM["memory"]
        OBJ["objective"]
        NOTES["notes"]
        SCHED["schedule"]
    end

    subgraph External["External Tools"]
        WEB["web_search"]
        BROWSE["browse"]
        EMAIL["send_email"]
        CODE["execute_code"]
    end

    subgraph Exec["Execution"]
        EXECUTOR["Tool Executor"]
        POOL["Thread Pool"]
    end

    DEC --> SCHEMA
    BuiltIn --> EXECUTOR
    External --> DEC
    EXECUTOR --> POOL`,

            'scheduler': `flowchart TB
    subgraph Scheduler["Scheduler"]
        LOOP["Scheduler Loop"]
        QUEUE["Task Queue"]
        TYPES["Schedule Types"]
    end

    subgraph Types["at / every / cron"]
        AT["at: ISO timestamp"]
        EVERY["every: 5m, 2h, 1d"]
        CRON["cron: 0 9 * * 1-5"]
    end

    subgraph Objectives["Background Objectives"]
        CREATE["Create Objective"]
        THREAD["Dedicated Thread"]
        STATUS["Status Tracking"]
    end

    subgraph Execution["Execution"]
        RUN["agent.run_async()"]
        START["emit task_start"]
        END["emit task_end"]
    end

    LOOP --> QUEUE
    TYPES --> AT
    TYPES --> EVERY
    TYPES --> CRON
    QUEUE --> START
    START --> RUN
    RUN --> END
    CREATE --> THREAD
    THREAD --> STATUS
    THREAD --> RUN`,

            'events': `flowchart TB
    subgraph Emitter["EventEmitter"]
        ON["on()"]
        EMIT["emit()"]
        OFF["off()"]
    end

    subgraph Events["Agent Events"]
        TOOL_S["tool_start"]
        TOOL_E["tool_end"]
        OBJ_S["objective_start"]
        OBJ_E["objective_end"]
        TASK_S["task_start"]
        TASK_E["task_end"]
    end

    subgraph Subscribers["Subscribers"]
        CLI_H["CLI Handler"]
        MEM_H["Memory Hooks"]
        CUSTOM["Custom Handlers"]
    end

    ON --> EMIT
    Events --> EMIT
    EMIT --> CLI_H
    EMIT --> MEM_H
    EMIT --> CUSTOM`,

            'channels': `flowchart TB
    subgraph Input["Input Listeners"]
        CLI_I["CLI stdin"]
        EMAIL_I["Email Poller"]
        VOICE_I["Voice STT"]
        API_I["FastAPI"]
    end

    subgraph Agent["Agent Core"]
        CORE["Agent"]
        SENDERS["Senders Registry"]
        CTX["Current Context"]
    end

    subgraph Output["Output Senders"]
        CLI_O["Terminal"]
        EMAIL_O["Email API"]
        VOICE_O["TTS"]
        API_O["JSON Response"]
    end

    subgraph Concurrency["Thread Safety"]
        LOCKS["Per-Thread Locks"]
        GATHER["asyncio.gather()"]
        SAFE["ThreadSafeList"]
    end

    Input --> CORE
    CORE --> SENDERS
    SENDERS --> Output
    Input --> CTX
    CTX --> CORE
    CORE --> LOCKS
    Input --> GATHER`,

            'models': `classDiagram
    class Agent {
        +Dict threads
        +Dict objectives
        +Dict tools
        +Scheduler scheduler
        +Memory memory
        +run_async()
        +register()
    }

    class Objective {
        +str id
        +str goal
        +str status
        +str thread_id
    }

    class Tool {
        +str name
        +Callable fn
        +dict schema
        +execute()
    }

    class ScheduledTask {
        +str id
        +str name
        +Schedule schedule
        +datetime next_run
    }

    class Event {
        +str id
        +datetime timestamp
        +str channel
        +str content
    }

    class Entity {
        +str id
        +str name
        +str type
    }

    Agent --> Objective
    Agent --> Tool
    Agent --> ScheduledTask
    Agent --> Event
    Agent --> Entity`,

            'files': `flowchart TB
    subgraph Root["babyagi/"]
        MAIN["main.py"]
        AGENT["agent.py"]
        SCHED["scheduler.py"]
        CONFIG["config.py"]
        SERVER["server.py"]
    end

    subgraph MemDir["memory/"]
        M_INIT["__init__.py"]
        STORE["store.py"]
        MODELS["models.py"]
        EXTRACT["extraction.py"]
    end

    subgraph ListDir["listeners/"]
        L_CLI["cli.py"]
        L_EMAIL["email.py"]
        L_VOICE["voice.py"]
    end

    subgraph SendDir["senders/"]
        S_CLI["cli.py"]
        S_EMAIL["email.py"]
    end

    subgraph ToolDir["tools/"]
        T_WEB["web.py"]
        T_EMAIL["email.py"]
        T_SANDBOX["sandbox.py"]
    end

    MAIN --> AGENT
    AGENT --> SCHED
    AGENT --> CONFIG
    AGENT --> M_INIT
    AGENT --> L_CLI
    AGENT --> ToolDir`,

            'complete': `flowchart TB
    START((Start)) --> MODE{Mode?}

    MODE -->|cli| CLI_START["Init Agent"]
    MODE -->|channels| CHAN_START["Init Agent"]
    MODE -->|serve| SERVER_START["Init FastAPI"]

    CLI_START --> LOAD["Load Config"]
    CHAN_START --> LOAD
    SERVER_START --> LOAD

    LOAD --> INIT["Create Agent"]
    INIT --> TOOLS["Load Tools"]
    TOOLS --> MEM{"Memory?"}

    MEM -->|Yes| SETUP["Init SQLite"]
    MEM -->|No| SKIP["In-memory"]

    SETUP --> LISTENERS
    SKIP --> LISTENERS

    LISTENERS["Start Listeners"] --> GATHER["asyncio.gather()"]

    GATHER --> CLI_LOOP["CLI Loop"]
    GATHER --> EMAIL_LOOP["Email Loop"]
    GATHER --> SCHED_LOOP["Scheduler"]

    CLI_LOOP --> PROCESS["run_async()"]
    EMAIL_LOOP --> PROCESS
    SCHED_LOOP --> PROCESS

    PROCESS --> LOCK["Acquire Lock"]
    LOCK --> CLAUDE["Call Claude"]
    CLAUDE --> TOOLS_CHECK{"Tools?"}

    TOOLS_CHECK -->|Yes| EXEC["Execute"]
    EXEC --> CLAUDE

    TOOLS_CHECK -->|No| RESPOND["Send Response"]
    RESPOND --> UNLOCK["Release Lock"]
    UNLOCK --> CLI_LOOP`
        };

        // Tab navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.diagram-section').forEach(s => s.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.target).classList.add('active');
            });
        });

        // Render diagrams
        async function renderDiagrams() {
            const { renderMermaid } = beautifulMermaid;

            for (const [key, mermaidCode] of Object.entries(diagrams)) {
                const container = document.querySelector(`[data-diagram="${key}"]`);
                if (!container) continue;

                container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Rendering diagram...</span></div>';

                try {
                    const svg = await renderMermaid(mermaidCode, {
                        theme: 'dark'
                    });
                    container.innerHTML = svg;
                } catch (error) {
                    console.error(`Error rendering ${key}:`, error);
                    container.innerHTML = `<div class="error">Failed to render diagram: ${error.message}</div>`;
                }
            }
        }

        // Initialize
        renderDiagrams();
    </script>
</body>
</html>
